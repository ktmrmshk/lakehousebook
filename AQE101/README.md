# Adaptive Query Execution

Sparkは最適な処理実行プランを作るためにコストベースの最適化を行なっています。この最適化には処理実行を開始する前に利用可能な統計情報、例えばそのテーブルの行の数、カラムのユニーク値の個数、Null値、最小・最大数などを使用します。これよって、結合(JOIN)の方式をソートマージ結合よりも高速に実施可能なブロードキャストハッシュ結合に変更するなどの最適化を行なっています。ただし、最大最適化に必要な統計値(カーディナリティやある時点でのパーティションのサイズなど)は全ては処理事前にはわかっていません。そのため、これらの値は推定や経験則による想定値が使用されています。

そこで、実行プランを処理している最中にこれらの統計値を取得して、実行プランを再度最適化する方式が導入されました。これがAdaptive Query Execution(適応クエリ実行, AQE)です。AQEでは特に以下の4つのパフォーマンス劣化要因の最適化を実施します。

## 動的なシャッフルパーティションの結合(Dynamically coalescing shuffle partitions)

Sparkではデータをシャッフルパーティションという細かいデータに分割し、クラスタネットワーク上で分散的に演算処理を実施していきます。
この際、一つのシャッフルパーティションのサイズ


## 動的な結合方式の切り替え(Dynamically switching join strategies)



## 動的な結合時スキューの緩和(Dynamically optimizing skew joins)

